<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XASqlSessionManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mybatis-guice</a> &gt; <a href="index.source.html" class="el_package">org.mybatis.guice.transactional</a> &gt; <span class="el_source">XASqlSessionManager.java</span></div><h1>XASqlSessionManager.java</h1><pre class="source lang-java linenums">/*
 *    Copyright 2009-2025 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       https://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.mybatis.guice.transactional;

import java.lang.reflect.Field;
import java.util.Arrays;
import java.util.IdentityHashMap;
import java.util.concurrent.ConcurrentHashMap;

import javax.transaction.xa.XAException;
import javax.transaction.xa.XAResource;
import javax.transaction.xa.Xid;

import org.apache.ibatis.logging.Log;
import org.apache.ibatis.logging.LogFactory;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionManager;

public class XASqlSessionManager implements XAResource {
<span class="fc" id="L33">  private static final Log log = LogFactory.getLog(XASqlSessionManager.class);</span>

  public static final int NO_TX = 0;
  public static final int STARTED = 1;
  public static final int ENDED = 2;
  public static final int PREPARED = 3;

  private SqlSessionManager sqlSessionManager;
  private int transactionTimeout;
  private String id;
  private Xid xid;
<span class="fc" id="L44">  private int state = NO_TX;</span>

<span class="fc" id="L46">  private static ConcurrentHashMap&lt;GlobalKey, GlobalToken&gt; globalTokens = new ConcurrentHashMap&lt;&gt;();</span>

<span class="fc" id="L48">  public XASqlSessionManager(SqlSessionManager sqlSessionManager) {</span>
<span class="fc" id="L49">    this.sqlSessionManager = sqlSessionManager;</span>
<span class="fc" id="L50">    id = sqlSessionManager.getConfiguration().getEnvironment().getId();</span>
<span class="fc" id="L51">  }</span>

  public String getId() {
<span class="nc" id="L54">    return id;</span>
  }

  public int getState() {
<span class="nc" id="L58">    return state;</span>
  }

  private String xlatedState() {
<span class="nc bnc" id="L62" title="All 5 branches missed.">    switch (state) {</span>
      case NO_TX:
<span class="nc" id="L64">        return &quot;NO_TX&quot;;</span>
      case STARTED:
<span class="nc" id="L66">        return &quot;STARTED&quot;;</span>
      case ENDED:
<span class="nc" id="L68">        return &quot;ENDED&quot;;</span>
      case PREPARED:
<span class="nc" id="L70">        return &quot;PREPARED&quot;;</span>
      default:
<span class="nc" id="L72">        return &quot;!invalid state (&quot; + state + &quot;)!&quot;;</span>
    }
  }

  private String decodeXAResourceFlag(int flag) {
<span class="nc bnc" id="L77" title="All 10 branches missed.">    switch (flag) {</span>
      case XAResource.TMENDRSCAN:
<span class="nc" id="L79">        return &quot;TMENDRSCAN&quot;;</span>
      case XAResource.TMFAIL:
<span class="nc" id="L81">        return &quot;TMFAIL&quot;;</span>
      case XAResource.TMJOIN:
<span class="nc" id="L83">        return &quot;TMJOIN&quot;;</span>
      case XAResource.TMNOFLAGS:
<span class="nc" id="L85">        return &quot;TMNOFLAGS&quot;;</span>
      case XAResource.TMONEPHASE:
<span class="nc" id="L87">        return &quot;TMONEPHASE&quot;;</span>
      case XAResource.TMRESUME:
<span class="nc" id="L89">        return &quot;TMRESUME&quot;;</span>
      case XAResource.TMSTARTRSCAN:
<span class="nc" id="L91">        return &quot;TMSTARTRSCAN&quot;;</span>
      case XAResource.TMSUCCESS:
<span class="nc" id="L93">        return &quot;TMSUCCESS&quot;;</span>
      case XAResource.TMSUSPEND:
<span class="nc" id="L95">        return &quot;TMSUSPEND&quot;;</span>
      default:
<span class="nc" id="L97">        return &quot;&quot; + flag;</span>
    }
  }

  @Override
  public int getTransactionTimeout() throws XAException {
<span class="nc" id="L103">    return transactionTimeout;</span>
  }

  @Override
  public boolean setTransactionTimeout(int second) throws XAException {
<span class="fc" id="L108">    transactionTimeout = second;</span>
<span class="fc" id="L109">    return true;</span>
  }

  @Override
  public void forget(Xid xid) throws XAException {
<span class="nc" id="L114">  }</span>

  @Override
  public Xid[] recover(int flags) throws XAException {
<span class="nc" id="L118">    return new Xid[0];</span>
  }

  @Override
  public boolean isSameRM(XAResource xares) throws XAException {
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">    return this == xares;</span>
  }

  @Override
  public void start(Xid xid, int flag) throws XAException {
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L129">      log.debug(</span>
<span class="nc" id="L130">          id + &quot;: call start old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot;, flag=&quot; + decodeXAResourceFlag(flag));</span>
    }

<span class="pc bpc" id="L133" title="3 of 4 branches missed.">    if (flag != XAResource.TMNOFLAGS &amp;&amp; flag != XAResource.TMJOIN) {</span>
<span class="nc" id="L134">      throw new MyBatisXAException(id + &quot;: unsupported start flag &quot; + decodeXAResourceFlag(flag),</span>
          XAException.XAER_RMERR);
    }

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L139">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L142" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">      if (this.xid != null) {</span>
<span class="nc" id="L144">        throw new MyBatisXAException(id + &quot;: resource already started on XID &quot; + this.xid, XAException.XAER_PROTO);</span>
      } else {
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (flag == XAResource.TMJOIN) {</span>
<span class="nc" id="L147">          throw new MyBatisXAException(id + &quot;: resource not yet started&quot;, XAException.XAER_PROTO);</span>
        } else {
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">          if (log.isDebugEnabled()) {</span>
<span class="nc" id="L150">            log.debug(id + &quot;: OK to start, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot;, flag=&quot;</span>
<span class="nc" id="L151">                + decodeXAResourceFlag(flag));</span>
          }
<span class="fc" id="L153">          this.xid = xid;</span>
        }
      }
<span class="nc bnc" id="L156" title="All 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="nc" id="L157">      throw new MyBatisXAException(id + &quot;: resource already started on XID &quot; + this.xid, XAException.XAER_PROTO);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">      if (flag == XAResource.TMNOFLAGS) {</span>
<span class="nc" id="L160">        throw new MyBatisXAException(id + &quot;: resource already registered XID &quot; + this.xid, XAException.XAER_DUPID);</span>
      } else {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (xid.equals(this.xid)) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">          if (log.isDebugEnabled()) {</span>
<span class="nc" id="L164">            log.debug(id + &quot;: OK to join, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot;, flag=&quot;</span>
<span class="nc" id="L165">                + decodeXAResourceFlag(flag));</span>
          }
        } else {
<span class="nc" id="L168">          throw new MyBatisXAException(id + &quot;: resource already started on XID &quot; + this.xid</span>
              + &quot; - cannot start it on more than one XID at a time&quot;, XAException.XAER_RMERR);
        }
      }
<span class="nc bnc" id="L172" title="All 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="nc" id="L173">      throw new MyBatisXAException(id + &quot;: resource already prepared on XID &quot; + this.xid, XAException.XAER_PROTO);</span>
    }

<span class="fc" id="L176">    state = STARTED;</span>
<span class="fc" id="L177">    parentSuspend(xid);</span>
<span class="fc" id="L178">  }</span>

  @Override
  public void end(Xid xid, int flag) throws XAException {
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L183">      log.debug(</span>
<span class="nc" id="L184">          id + &quot;: call end old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot; and flag &quot; + decodeXAResourceFlag(flag));</span>
    }

<span class="pc bpc" id="L187" title="1 of 4 branches missed.">    if (flag != XAResource.TMSUCCESS &amp;&amp; flag != XAResource.TMFAIL) {</span>
<span class="nc" id="L188">      throw new MyBatisXAException(id + &quot;: unsupported end flag &quot; + decodeXAResourceFlag(flag), XAException.XAER_RMERR);</span>
    }

<span class="pc bpc" id="L191" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L192">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L195" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="nc" id="L196">      throw new MyBatisXAException(id + &quot;: resource never started on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">      if (this.xid.equals(xid)) {</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L200">          log.debug(</span>
<span class="nc" id="L201">              id + &quot;: OK to end, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot;, flag=&quot; + decodeXAResourceFlag(flag));</span>
        }
      } else {
<span class="nc" id="L204">        throw new MyBatisXAException(</span>
            id + &quot;: resource already started on XID &quot; + this.xid + &quot; - cannot end it on another XID &quot; + xid,
            XAException.XAER_PROTO);
      }
<span class="nc bnc" id="L208" title="All 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="nc" id="L209">      throw new MyBatisXAException(id + &quot;: resource already ended on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="nc" id="L211">      throw new MyBatisXAException(id + &quot;: cannot end, resource already prepared on XID &quot; + xid,</span>
          XAException.XAER_PROTO);
    }

<span class="fc bfc" id="L215" title="All 2 branches covered.">    if (flag == XAResource.TMFAIL) {</span>
      // Rollback transaction. After call method end() call method rollback()
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L218">        log.debug(id + &quot;: after end TMFAIL reset state to ENDED and roolback&quot;);</span>
      }
    }

<span class="fc" id="L222">    this.state = ENDED;</span>
<span class="fc" id="L223">  }</span>

  @Override
  public int prepare(Xid xid) throws XAException {
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L228">      log.debug(id + &quot;: call prepare old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
    }

<span class="pc bpc" id="L231" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L232">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L235" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="nc" id="L236">      throw new MyBatisXAException(id + &quot;: resource never started on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="nc" id="L238">      throw new MyBatisXAException(id + &quot;: resource never ended on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">      if (this.xid.equals(xid)) {</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L242">          log.debug(id + &quot;: OK to prepare, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
        }
      } else {
<span class="nc" id="L245">        throw new MyBatisXAException(</span>
            id + &quot;: resource already started on XID &quot; + this.xid + &quot; - cannot prepare it on another XID &quot; + xid,
            XAException.XAER_PROTO);
      }
<span class="nc bnc" id="L249" title="All 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="nc" id="L250">      throw new MyBatisXAException(id + &quot;: resource already prepared on XID &quot; + this.xid, XAException.XAER_PROTO);</span>
    }

<span class="fc" id="L253">    this.state = PREPARED;</span>
<span class="fc" id="L254">    return XAResource.XA_OK;</span>
  }

  @Override
  public void commit(Xid xid, boolean onePhase) throws XAException {
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L260">      log.debug(id + &quot;: call commit old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot; onePhase is &quot; + onePhase);</span>
    }

<span class="pc bpc" id="L263" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L264">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L267" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="nc" id="L268">      throw new MyBatisXAException(id + &quot;: resource never started on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="nc" id="L270">      throw new MyBatisXAException(id + &quot;: resource never ended on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">      if (onePhase) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L274">          log.debug(id + &quot;: OK to commit with 1PC, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
        }
      } else {
<span class="nc" id="L277">        throw new MyBatisXAException(id + &quot;: resource never prepared on XID &quot; + xid, XAException.XAER_PROTO);</span>
      }
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">      if (!onePhase) {</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (this.xid.equals(xid)) {</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">          if (log.isDebugEnabled()) {</span>
<span class="nc" id="L283">            log.debug(id + &quot;: OK to commit, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
          }
        } else {
<span class="nc" id="L286">          throw new MyBatisXAException(</span>
              id + &quot;: resource already started on XID &quot; + this.xid + &quot; - cannot commit it on another XID &quot; + xid,
              XAException.XAER_PROTO);
        }
      } else {
<span class="nc" id="L291">        throw new MyBatisXAException(id + &quot;: cannot commit in one phase as resource has been prepared on XID &quot; + xid,</span>
            XAException.XAER_PROTO);
      }
    }

    try {
<span class="fc" id="L297">      parentResume(xid);</span>
    } finally {
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L300">        log.debug(id + &quot;: after commit reset state to NO_TX&quot;);</span>
      }
<span class="fc" id="L302">      this.state = NO_TX;</span>
<span class="fc" id="L303">      this.xid = null;</span>
    }
<span class="fc" id="L305">  }</span>

  @Override
  public void rollback(Xid xid) throws XAException {
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L310">      log.debug(id + &quot;: call roolback old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
    }

<span class="pc bpc" id="L313" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L314">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L317" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="nc" id="L318">      throw new MyBatisXAException(id + &quot;: resource never started on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="nc" id="L320">      throw new MyBatisXAException(id + &quot;: resource never ended on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">      if (this.xid.equals(xid)) {</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L324">          log.debug(id + &quot;: OK to rollback, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
        }
      } else {
<span class="nc" id="L327">        throw new MyBatisXAException(</span>
            id + &quot;: resource already started on XID &quot; + this.xid + &quot; - cannot roll it back on another XID &quot; + xid,
            XAException.XAER_PROTO);
      }
<span class="nc bnc" id="L331" title="All 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L333">        log.debug(id + &quot;: rollback reset state from PREPARED to NO_TX&quot;);</span>
      }
<span class="nc" id="L335">      this.state = NO_TX;</span>
<span class="nc" id="L336">      throw new MyBatisXAException(id + &quot;: resource committed during prepare on XID &quot; + this.xid,</span>
          XAException.XA_HEURCOM);
    }

    try {
<span class="fc" id="L341">      parentResume(xid);</span>
    } finally {
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L344">        log.debug(id + &quot;: after rollback reset state to NO_TX&quot;);</span>
      }
<span class="fc" id="L346">      this.state = NO_TX;</span>
<span class="fc" id="L347">      this.xid = null;</span>
    }
<span class="fc" id="L349">  }</span>

  private void parentSuspend(Xid xid) {
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L353">      log.debug(id + &quot;: suspend parent session &quot; + xid);</span>
    }

<span class="fc" id="L356">    byte[] trId = xid.getGlobalTransactionId();</span>
<span class="fc" id="L357">    GlobalKey key = new GlobalKey(trId);</span>
<span class="fc" id="L358">    GlobalToken globalToken = globalTokens.get(key);</span>

<span class="fc bfc" id="L360" title="All 2 branches covered.">    if (globalToken == null) {</span>
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L362">        log.debug(id + &quot;: add GlobalToken &quot; + key);</span>
      }

<span class="fc" id="L365">      globalTokens.put(key, globalToken = new GlobalToken());</span>
    } else {
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L368">        log.debug(id + &quot;: present GlobalToken &quot; + key);</span>
      }
    }
<span class="fc" id="L371">    globalToken.parentSuspend(id, sqlSessionManager);</span>
<span class="fc" id="L372">  }</span>

  private void parentResume(Xid xid) {
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L376">      log.debug(id + &quot;: resume parent session &quot; + xid);</span>
    }

<span class="fc" id="L379">    byte[] trId = xid.getGlobalTransactionId();</span>
<span class="fc" id="L380">    GlobalKey key = new GlobalKey(trId);</span>
<span class="fc" id="L381">    GlobalToken globalToken = globalTokens.get(key);</span>

<span class="pc bpc" id="L383" title="1 of 2 branches missed.">    if (globalToken != null) {</span>
<span class="fc" id="L384">      globalToken.parentResume(id, sqlSessionManager);</span>

<span class="fc bfc" id="L386" title="All 2 branches covered.">      if (globalToken.isEmpty()) {</span>
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L388">          log.debug(id + &quot;: remove GlobalToken &quot; + key);</span>
        }

<span class="fc" id="L391">        globalTokens.remove(key);</span>
      } else {
<span class="pc bpc" id="L393" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L394">          log.debug(id + &quot;: not remove GlobalToken &quot; + key);</span>
        }
      }
    } else {
<span class="nc bnc" id="L398" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L399">        log.debug(id + &quot;: not find GlobalToken &quot; + key);</span>
      }
    }
<span class="fc" id="L402">  }</span>

  static class GlobalKey {
    final byte[] globalId;
    final int arrayHash;

<span class="fc" id="L408">    public GlobalKey(byte[] globalId) {</span>
<span class="fc" id="L409">      this.globalId = globalId;</span>
<span class="fc" id="L410">      this.arrayHash = Arrays.hashCode(globalId);</span>
<span class="fc" id="L411">    }</span>

    @Override
    public int hashCode() {
<span class="fc" id="L415">      return arrayHash;</span>
    }

    @Override
    public boolean equals(Object obj) {
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">      if (this == obj) {</span>
<span class="nc" id="L421">        return true;</span>
      }

<span class="pc bpc" id="L424" title="1 of 2 branches missed.">      if (obj == null) {</span>
<span class="nc" id="L425">        return false;</span>
      }

<span class="pc bpc" id="L428" title="1 of 2 branches missed.">      if (getClass() != obj.getClass()) {</span>
<span class="nc" id="L429">        return false;</span>
      }

<span class="fc" id="L432">      GlobalKey other = (GlobalKey) obj;</span>
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">      if (!Arrays.equals(globalId, other.globalId)) {</span>
<span class="nc" id="L434">        return false;</span>
      }
<span class="fc" id="L436">      return true;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L441">      StringBuilder s = new StringBuilder();</span>
<span class="nc" id="L442">      s.append(&quot;[Xid:globalId=&quot;);</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">      for (int i = 0; i &lt; globalId.length; i++) {</span>
<span class="nc" id="L444">        s.append(Integer.toHexString(globalId[i]));</span>
      }
<span class="nc" id="L446">      s.append(&quot;,length=&quot;).append(globalId.length);</span>
<span class="nc" id="L447">      return s.toString();</span>
    }
  }

  static class GlobalToken {
<span class="fc" id="L452">    private final Log log = LogFactory.getLog(getClass());</span>
<span class="fc" id="L453">    IdentityHashMap&lt;SqlSessionManager, Token&gt; tokens = new IdentityHashMap&lt;SqlSessionManager, XASqlSessionManager.Token&gt;();</span>

<span class="fc" id="L455">    public GlobalToken() {</span>
<span class="fc" id="L456">    }</span>

    void parentSuspend(String id, SqlSessionManager sqlSessionManager) {
<span class="fc" id="L459">      Token token = tokens.get(sqlSessionManager);</span>

<span class="fc bfc" id="L461" title="All 2 branches covered.">      if (token == null) {</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L463">          log.debug(id + &quot;: add Token &quot; + sqlSessionManager);</span>
        }

<span class="fc" id="L466">        token = new Token(sqlSessionManager);</span>
<span class="fc" id="L467">        tokens.put(sqlSessionManager, token);</span>
      } else {
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L470">          log.debug(id + &quot;: present Token &quot; + sqlSessionManager);</span>
        }
      }
<span class="fc" id="L473">      token.parentSuspend(id);</span>
<span class="fc" id="L474">    }</span>

    void parentResume(String id, SqlSessionManager sqlSessionManager) {
<span class="fc" id="L477">      Token token = tokens.get(sqlSessionManager);</span>

<span class="pc bpc" id="L479" title="1 of 2 branches missed.">      if (token != null) {</span>
<span class="fc" id="L480">        token.parentResume(id);</span>

        // remove last
<span class="fc bfc" id="L483" title="All 2 branches covered.">        if (token.isFirst()) {</span>
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">          if (log.isDebugEnabled()) {</span>
<span class="nc" id="L485">            log.debug(id + &quot;: remove parent session &quot; + sqlSessionManager);</span>
          }

<span class="fc" id="L488">          tokens.remove(sqlSessionManager);</span>
        }
      } else {
<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L492">          log.debug(id + &quot;: not find parent session &quot; + sqlSessionManager);</span>
        }
      }
<span class="fc" id="L495">    }</span>

    boolean isEmpty() {
<span class="fc" id="L498">      return tokens.isEmpty();</span>
    }
  }

  static class Token {
<span class="fc" id="L503">    private final Log log = LogFactory.getLog(getClass());</span>
    final SqlSessionManager sqlSessionManager;
    ThreadLocal&lt;SqlSession&gt; localSqlSession;
    SqlSession suspendedSqlSession;
    int count;

    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L510">    public Token(SqlSessionManager sqlSessionManager) {</span>
<span class="fc" id="L511">      this.sqlSessionManager = sqlSessionManager;</span>
<span class="fc" id="L512">      this.count = 0;</span>
      try {
<span class="fc" id="L514">        Field field = SqlSessionManager.class.getDeclaredField(&quot;localSqlSession&quot;);</span>
<span class="fc" id="L515">        field.setAccessible(true);</span>
<span class="fc" id="L516">        localSqlSession = (ThreadLocal&lt;SqlSession&gt;) field.get(sqlSessionManager);</span>
<span class="nc" id="L517">      } catch (Exception e) {</span>
<span class="fc" id="L518">      }</span>
<span class="fc" id="L519">    }</span>

    boolean isFirst() {
<span class="fc bfc" id="L522" title="All 2 branches covered.">      return count == 0;</span>
    }

    void parentSuspend(String id) {
<span class="fc bfc" id="L526" title="All 2 branches covered.">      if (isFirst()) {</span>
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L528">          log.debug(id + &quot; suspend parent session&quot;);</span>
        }

<span class="pc bpc" id="L531" title="1 of 2 branches missed.">        if (localSqlSession != null) {</span>
<span class="fc" id="L532">          suspendedSqlSession = localSqlSession.get();</span>
<span class="fc" id="L533">          localSqlSession.remove();</span>
        }
      } else {
<span class="pc bpc" id="L536" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L537">          log.debug(id + &quot; skip suspend parent session&quot;);</span>
        }
      }
<span class="fc" id="L540">      count++;</span>
<span class="fc" id="L541">    }</span>

    void parentResume(String id) {
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">      if (count &gt; 0) {</span>
<span class="fc" id="L545">        count--;</span>
      }

<span class="fc bfc" id="L548" title="All 2 branches covered.">      if (isFirst()) {</span>
<span class="pc bpc" id="L549" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L550">          log.debug(id + &quot; resume parent session&quot;);</span>
        }

<span class="pc bpc" id="L553" title="1 of 2 branches missed.">        if (localSqlSession != null) {</span>
<span class="fc bfc" id="L554" title="All 2 branches covered.">          if (suspendedSqlSession == null) {</span>
<span class="fc" id="L555">            localSqlSession.remove();</span>
          } else {
<span class="fc" id="L557">            localSqlSession.set(suspendedSqlSession);</span>
<span class="fc" id="L558">            suspendedSqlSession = null;</span>
          }
        }
      } else {
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L563">          log.debug(id + &quot; skip resume parent session&quot;);</span>
        }
      }
<span class="fc" id="L566">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>